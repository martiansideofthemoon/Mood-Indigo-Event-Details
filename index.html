<!DOCTYPE html>
<html ng-app="myApp" >
<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src= "http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script> 
<link rel='stylesheet' href='node_modules/textangular/dist/textAngular.css'>
<link href="http://designers.hubspot.com/hs-fs/hub/327485/file-2054199286-css/font-awesome.css" rel="stylesheet">
<script src='node_modules/textangular/dist/textAngular-rangy.min.js'></script>
<script src='node_modules/textangular/dist/textAngular-sanitize.min.js'></script>
<script src='node_modules/textangular/dist/textAngular.min.js'></script>
<body ng-controller="validateCtrl">
<div class="container">
<form name="myForm" ng-hide="isValid" novalidate>
<div class="form-group" style="width:30%;">
<label for="username">Username</label>
<input type="text" id="username" class="form-control" name="user" ng-model="user.username" required>
<label for="password">Password</label>
<input id="password" class="form-control" data-ng-model='user.password' type="password" name='password' placeholder='password' required>
</p>
<button class="btn btn-default" ng-click="validate()">Click me!</button>
<p ng-show="loginError">Invalid Username / Password.</p>
</div>
</form>


<div ng-show="isValid">

<form class="form-inline">
<select class="form-control" ng-model="types" ng-options="x.id as x.name for x in records" ng-change="loadDetails(LOAD_GENRES)"> 
</select>

<select class="form-control" ng-model="genres" ng-options="x.id as x.name for x in genre_options" ng-change="loadDetails(LOAD_EVENTS)">
</select>

<select class="form-control" ng-model="events" ng-options="x.event_id as x.name for x in event_options" ng-change="loadDetails(LOAD_EVENT_DATA)">
</select>
</form>
<p ng-bind-html="currentgenre"></p>
<form class="form-inline">
<button class="btn btn-default" ng-click="addEvent()">Add an Event</button>
 <input class="form-control" type="text" ng-model="add_event_text"> 
</form>
<br>
<div ng-repeat="p in event_parameters">
    <form class="form-inline">
    <label type="text" for="p.ref">{{p.help_text}}</label>
    <input id="p.ref" class="form-control" type="text" ng-hide="p.textangular" ng-model="p.name" value="">
    <button class="btn btn-default" ng-show="p.textangular" ng-click="p.active=!p.active">{{!p.active? "Edit" : "Save"}}</button>
    </form>
    <div ng-show="p.active" style="width:70%; border-style:groove; border-width:5px; border-color:blue" text-angular ng-model="p.name"></div>
</div>
<button ng-click="update()">Update</button>
<p ng-show="fields_not_filled">Fill all fields</p>

</div>
    
</div>


<script>
var app = angular.module('myApp',['textAngular']);
app.controller('validateCtrl', function($scope,$http) {
	$scope.event_parameters=[{"name":"","help_text":"Name of the Event: ","ref":"name","active":false,"textangular":false},
							 {"name":"","help_text":"Oneline Name: ","ref":"oneline","active":false,"textangular":false},
							 {"name":"","help_text":"Introduction: ","ref":"intro","active":false,"textangular":false},
							 {"name":"","help_text":"Genre :","ref":"genre","active":false,"textangular":false},
							 {"name":"","help_text":"Genrebaap :","ref":"genrebaap","active":false,"textangular":false},
							 {"name":"","help_text":"Rules :","ref":"rules","active":false,"textangular":true},
							 {"name":"","help_text":"Event ID: ","ref":"event_id","active":false,"textangular":false},
							 {"name":"","help_text":"Prizes :","ref":"prizes","active":false,"textangular":false},
							 {"name":"","help_text":"Registration :","ref":"registration","active":false,"textangular":true},
							 {"name":"","help_text":"Multicity: ","ref":"multicity","active":false,"textangular":true}
							 ];
	$scope.LOAD_GENRES=1;
	$scope.GENRE_EVENT_ID=0;
	$scope.fields_not_filled=false;
	$scope.LOAD_EVENTS=2;
	$scope.LOAD_EVENT_DATA=3;
	$scope.valid_users = [
	{
	"username": "kalpesh",
	"password": "kalpesh"
	}
	]
	$scope.isValid=false;
	$http.get("http://localhost:8888/api/data")
    .success(function(data,status) {
    		$scope.records = data;	
    });

    $scope.validate = function()
    {
    	var send_data="username="+$scope.user.username+"&password="+$scope.user.password;
    	$http({ 
        method : 'POST', 
        url : 'http://localhost:8888/checkLogin', 
        data : send_data, 
        responseType : "json",
        headers: {
            "Content-Type": 'application/x-www-form-urlencoded'
        }
      }).success(function(data, status, headers, config){
       		console.log(data);
       		if (data)
       		{
       			$scope.isValid=true;
       			$scope.loginError=false;	
       		}
       		else
       		{
       			$scope.loginError=true;
       		}
       		
      });
    	//REPLACE WITH API CALL
    	
    };
    $scope.loadDetails = function(id)
    {
    	$scope.clearDetails(id);
    	switch (id)
    	{
    		case $scope.LOAD_GENRES:
    			$scope.genre_options=$scope.records[$scope.types-1]['genre'];
    			$scope.GENRE_EVENT_ID=$scope.records[$scope.types-1]['next_id'];
    			$scope.event_options=[];
    			break;
    		case $scope.LOAD_EVENTS:
    			$scope.event_options=$scope.genre_options[$scope.genres-1]['details'];
                $scope.currentgenre=$scope.genre_options[$scope.genres-1]['intro'];
    			break;
    		case $scope.LOAD_EVENT_DATA:
    			for (var i=0;i<$scope.event_options.length;i++)
    			{
    				if ($scope.event_options[i]['event_id']==$scope.events)
    				{
    					$scope.event_selected=$scope.event_options[i];
    					break;
    				}
    			}
    			console.log($scope.event_selected);
    			for (var i=0;i<$scope.event_parameters.length;i++)
    				$scope.event_parameters[i]['name']=$scope.event_selected[$scope.event_parameters[i]['ref']];
    			break;
    	}	
    };
    $scope.clearDetails = function(id)
    {
    	switch(id)
    	{
	    	case $scope.LOAD_GENRES:
	    		$scope.event_options=[];
			case $scope.LOAD_EVENTS:
				for (var i=0;i<$scope.event_parameters.length;i++)
					$scope.event_parameters[i]['name']="";
				break;
		}
    }
    $scope.update = function()
    {
    	if ($scope.types===undefined || $scope.events===undefined || $scope.genres===undefined)
    		$scope.fields_not_filled=true;
    	else
    	{
    		$scope.fields_not_filled=false;
    		var event_position=0;
    		for (var i=0;i<$scope.event_options.length;i++)
    			{
    				if ($scope.event_options[i]['event_id']==$scope.events)
    				{
    					event_position=i;
    					break;
    				}
    			}
    		for (var i=0;i<$scope.event_parameters.length;i++)
    			$scope.event_selected[$scope.event_parameters[i]['ref']]=$scope.event_parameters[i]['name'];

    		$scope.records[$scope.types-1]['genre'][$scope.genres-1]['details'][event_position]=$scope.event_selected;

    		var send_data="data="+encodeURIComponent(JSON.stringify($scope.records,null,4));
    		$http({ 
	        method : 'POST', 
	        url : 'http://localhost:8888/updateDetails', 
	        data : send_data, 
	        responseType : "json",
	        headers: {
	            "Content-Type": 'application/x-www-form-urlencoded'
	        }
	      }).success(function(data, status, headers, config){
	       		if(data)
                {
                    alert("successfully updated");
                }
                else
                {
                    alert("some error, Refresh and try again");
                }
	      });
    	}
    }
    $scope.addEvent = function()
    {
    	console.log($scope.add_event_text);
    	if ($scope.add_event_text===undefined || $scope.add_event_text==="")
    		$scope.add_event_text="Empty!!";
    	else if ($scope.types===undefined || $scope.genres===undefined)
    		$scope.add_event_text="Select Something!!";
    	else
    	{
    		var new_event={
                        "id": [
                            20
                        ],
                        "name": $scope.add_event_text,
                        "oneline": "",
                        "intro": "",
                        "genre": $scope.records[$scope.types-1]['genre'][$scope.genres-1]['name'],
                        "genrebaap": $scope.records[$scope.types-1]['name'],
                        "rules": "",
                        "event_id": $scope.GENRE_EVENT_ID,
                        "prizes": "",
                        "registration": "",
                        "multicity": ""
                    };
    		$scope.records[$scope.types-1]['genre'][$scope.genres-1]['details'].push(new_event);
    		console.log($scope.add_event_text);
    		console.log($scope.GENRE_EVENT_ID);
    		$scope.add_event_text="";
    		$scope.loadDetails($scope.LOAD_GENRES);
    		$scope.loadDetails($scope.LOAD_EVENTS);
    		$scope.events=$scope.GENRE_EVENT_ID;
    		$scope.loadDetails($scope.LOAD_EVENT_DATA);
    		$scope.records[$scope.types-1]['next_id']=$scope.GENRE_EVENT_ID+1;
    		//$scope.clearDetails($scope.LOAD_EVENTS);
    	}
    };

});
</script>
</body>
</html>
